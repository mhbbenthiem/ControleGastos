<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gastos Diários</title>
  <link rel="icon" href="alvo.png" type="image/x-icon">
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#6366f1" />

  <style>
    :root { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #818cf8;
      --secondary: #f3f4f6;
      --success: #10b981;
      --danger: #ef4444;
      --text: #1f2937;
      --text-light: #6b7280;
      --border: #e5e7eb;
      --bg: #f9fafb;
      --white: #ffffff;
      --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    
    * {
      box-sizing: border-box;
    }
    
    body { 
      margin: 0; 
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    
    header { 
      position: sticky; 
      top: 0; 
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: var(--white);
      padding: 20px 16px;
      box-shadow: var(--shadow-md);
      z-index: 100;
    }
    
    header h1 { 
      margin: 0; 
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }
    
    main { 
      max-width: 920px; 
      margin: 0 auto; 
      padding: 24px 16px;
    }
    
    .tabs { 
      display: flex; 
      gap: 8px; 
      margin-bottom: 24px;
      background: var(--white);
      padding: 6px;
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
    }
    
    .tab { 
      flex: 1;
      border: 0; 
      padding: 12px 16px;
      border-radius: 8px;
      background: transparent;
      cursor: pointer;
      font-weight: 500;
      color: var(--text-light);
      transition: all 0.2s ease;
      font-size: 14px;
    }
    
    .tab:hover {
      background: var(--secondary);
      color: var(--text);
    }
    
    .tab.active { 
      background: var(--primary);
      color: var(--white);
      box-shadow: var(--shadow-sm);
    }
    
    .card { 
      background: var(--white);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--shadow-sm);
      margin-bottom: 20px;
      border: 1px solid var(--border);
      transition: box-shadow 0.2s ease;
    }
    
    .card:hover {
      box-shadow: var(--shadow-md);
    }
    
    .grid { 
      display: grid; 
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    @media (max-width: 720px) { 
      .grid { 
        grid-template-columns: 1fr;
      }
      
      main {
        padding: 16px 12px;
      }
      
      .card {
        padding: 16px;
      }
    }
    
    label:not(.btn) { 
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
    }
    
    input, select, textarea { 
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1.5px solid var(--border);
      background: var(--white);
      font-size: 15px;
      transition: all 0.2s ease;
      color: var(--text);
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    input:disabled {
      background: var(--secondary);
      color: var(--text-light);
      cursor: not-allowed;
    }
    
    textarea { 
      min-height: 42px;
      resize: vertical;
      font-family: inherit;
    }
    
    .row { 
      display: flex;
      gap: 12px;
      align-items: end;
      flex-wrap: wrap;
    }
    
    .btn { 
      border: 0;
      padding: 12px 20px;
      border-radius: 10px;
      background: var(--primary);
      color: var(--white);
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }
    
    .btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn.secondary { 
      background: var(--secondary);
      color: var(--text);
      box-shadow: none;
    }
    
    .btn.secondary:hover {
      background: #e5e7eb;
    }
    
    .btn.danger { 
      background: var(--danger);
    }
    
    .btn.danger:hover {
      background: #dc2626;
    }
    
    .muted { 
      color: var(--text-light);
      font-size: 14px;
    }
    
    .list { 
      display: grid;
      gap: 10px;
    }
    
    .item { 
      display: flex;
      justify-content: space-between;
      gap: 12px;
      padding: 16px;
      border-radius: 12px;
      background: var(--bg);
      border: 1.5px solid var(--border);
      transition: all 0.2s ease;
    }
    
    .item:hover {
      border-color: var(--primary-light);
      background: var(--white);
      box-shadow: var(--shadow-sm);
    }
    
    .item strong { 
      display: block;
      color: var(--text);
      font-weight: 600;
      margin-bottom: 2px;
    }
    
    .item small { 
      display: block;
      color: var(--text-light);
      font-size: 13px;
    }
    
    .item .actions { 
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .kpi { 
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .pill { 
      background: var(--bg);
      border: 1.5px solid var(--border);
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 14px;
      white-space: nowrap;
    }
    
    .pill strong {
      color: var(--primary);
      font-weight: 700;
    }
    
    dialog { 
      border: 0;
      border-radius: 16px;
      max-width: 720px;
      width: calc(100% - 24px);
      box-shadow: var(--shadow-lg);
      padding: 0;
    }
    
    dialog::backdrop { 
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }
    
    .dialog-actions { 
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    
    .table { 
      width: 100%;
      border-collapse: collapse;
    }
    
    .table th, .table td { 
      text-align: left;
      padding: 14px 12px;
      border-bottom: 1px solid var(--border);
    }
    
    .table th {
      background: var(--bg);
      font-weight: 600;
      color: var(--text);
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .table tbody tr {
      transition: background 0.2s ease;
    }
    
    .table tbody tr:hover {
      background: var(--bg);
    }
    
    .right { 
      text-align: right;
    }
    
    .hidden { 
      display: none;
    }
    
    h2, h3 {
      color: var(--text);
      font-weight: 700;
    }
    
    /* Animações sutis */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .card {
      animation: slideIn 0.3s ease;
    }
    
    /* Melhorias para inputs de data */
    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="month"]::-webkit-calendar-picker-indicator {
      cursor: pointer;
      filter: opacity(0.6);
    }
    
    input[type="date"]::-webkit-calendar-picker-indicator:hover,
    input[type="month"]::-webkit-calendar-picker-indicator:hover {
      filter: opacity(1);
    }
    
    /* Scrollbar personalizada */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--secondary);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 5px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-light);
    }
  </style>
</head>

<body>
  <header>
    <h1>Controle de Gastos</h1>
  </header>

  <main>
    <div class="tabs">
        <button class="tab active" id="tabLancamentos">Lançamentos</button>
        <button class="tab" id="tabRelatorios">Relatório mensal</button>
        <button class="tab" id="tabCategorias">Por categoria</button>
    </div>


    <!-- Lançamentos -->
    <section id="viewLancamentos">
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="muted">Hoje</div>
            <div id="todayLabel" style="font-size:20px; font-weight:700;"></div>
          </div>
          <div class="card" id="cardNotify">
            <h2 style="margin:0 0 12px 0; font-size:18px;">Notificações (Telegram)</h2>

            <div class="grid">
              <div>
                <label>Identificador do usuário (user_key)</label>
                <input type="text" id="userKey" value="maria" />
                <div class="muted" style="margin-top:6px;">
                  No Telegram, envie: <strong>/link maria</strong> para vincular.
                </div>
              </div>

              <div>
                <label>Teto semanal (R$)</label>
                <input type="text" id="weeklyCap" inputmode="decimal" placeholder="ex: 600,00" />
                <div class="muted" style="margin-top:6px;">
                  Quando seus gastos na semana passarem do % abaixo, eu aviso.
                </div>
              </div>

              <div>
                <label>Alertar ao atingir (%)</label>
                <input type="number" id="alertPct" min="1" max="100" value="80" />
                <div class="muted" style="margin-top:6px;">Ex: 80 = avisa ao bater 80% do teto.</div>
              </div>
            </div>

            <div class="row" style="margin-top:12px; gap:10px;">
              <button class="btn" type="button" id="btnSaveSettings">Salvar configurações</button>
              <div class="muted" id="settingsMsg"></div>
            </div>
          </div>
          <div class="kpi">
            <div class="pill"><span class="muted">Total hoje:</span> <strong id="totalHoje">R$ 0,00</strong></div>
            <div class="pill"><span class="muted">Itens hoje:</span> <strong id="countHoje">0</strong></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 16px 0; font-size:18px;">Novo gasto</h2>
        <div class="grid">
          <div>
            <label>Data</label>
            <input type="date" id="fData" />
          </div>
          <div>
            <label>Loja</label>
            <select id="fLoja"></select>
            <button class="btn secondary" type="button" id="btnAddStoreF" style="margin-top:10px; width:100%;">Cadastrar loja</button>
          </div>
          <div>
            <label>Categoria</label>
            <select id="fCategoria">
                <option value="Mercado">Mercado</option>
                <option value="Restaurante/Bar/iFood">Restaurante/Bar/iFood</option>
                <option value="Farmácia">Farmácia</option>
                <option value="Roupas">Roupas</option>
                <option value="Beleza">Beleza</option>
                <option value="Passagem">Passagem</option>
                <option value="Outros">Outros</option>
            </select>
          </div>
          <div>
            <label>Item (produto)</label>
            <input type="text" placeholder="ex: Arroz 5kg" id="fItem" />
          </div>
          <div>
            <label>Valor (R$)</label>
            <input type="text" inputmode="decimal" placeholder="ex: 25,90" id="fValor" />
          </div>

                    <div>
            <label>Quantidade</label>
            <input type="text" inputmode="decimal" placeholder="ex: 2" id="fQtd" />
        </div>

        <div>
        <label>Unidade</label>
        <select id="fUnit">
            <option value="un">Unidade (un)</option>
            <option value="kg">Quilo (kg)</option>
            <option value="g">Gramas (g)</option>
            <option value="l">Litro (L)</option>
            <option value="ml">Mililitro (mL)</option>
        </select>
        </div>

        <div>
        <label>Preço por unidade</label>
        <input type="text" id="fUnitPrice" disabled placeholder="calculado automaticamente" />
        </div>


          <div>
            <label>Observação (opcional)</label>
            <input type="text" placeholder="ex: promoção" id="fObs" />
          </div>
        </div>
        <div class="row" style="margin-top:16px;">
          <button class="btn" id="btnAdd">Adicionar</button>
          <button class="btn secondary" id="btnLimpar">Limpar</button>
          <span class="muted" id="msgForm"></span>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <h2 style="margin:0; font-size:18px;">Lançamentos</h2>
            <div class="muted">Toque em "Editar" para alterar.</div>
          </div>
          <div class="row">
            <div>
              <label>Filtrar por data</label>
              <input type="date" id="filterDate" />
            </div>
            <button class="btn secondary" id="btnHoje">Hoje</button>
          </div>
        </div>

        <div class="list" id="listLancamentos" style="margin-top:16px;"></div>
        <div class="muted" id="emptyLancamentos" style="margin-top:8px;" class="hidden"></div>
      </div>
    </section>

    <!-- Relatórios -->
    <section id="viewRelatorios" class="hidden">
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <h2 style="margin:0; font-size:18px;">Relatório mensal</h2>
            <div class="muted">"Onde foi mais barato" por item (menor preço do mês por loja).</div>
          </div>
          <div>
            <label>Mês</label>
            <input type="month" id="monthPicker" />
          </div>
        </div>
      </div>

      <div class="card">
        <div class="kpi">
          <div class="pill"><span class="muted">Total no mês:</span> <strong id="totalMes">R$ 0,00</strong></div>
          <div class="pill"><span class="muted">Lançamentos:</span> <strong id="countMes">0</strong></div>
          <div class="pill"><span class="muted">Itens únicos:</span> <strong id="uniqueItens">0</strong></div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 12px 0; font-size:16px;">Mais barato por item</h3>
        <div style="overflow:auto;">
          <table class="table" id="tableCheapest">
            <thead>
              <tr>
                <th>Item</th>
                <th>Loja</th>
                <th class="right">Menor preço</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="muted" id="emptyReport" style="margin-top:8px;"></div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 12px 0; font-size:16px;">Total por categoria</h3>
        <div style="overflow:auto;">
          <table class="table" id="tableCat">
            <thead>
              <tr>
                <th>Categoria</th>
                <th class="right">Total</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="muted" id="emptyCat" style="margin-top:8px;"></div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 12px 0; font-size:16px;">Resumo por categoria (mês)</h3>
        <div id="catSections"></div>
        <div class="muted" id="emptyCatSections" style="margin-top:8px;"></div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 12px 0; font-size:16px;">
          Backup de dados
        </h3>

        <div class="row">
          <button class="btn secondary" id="btnExport">
            Exportar BD (JSON)
          </button>

          <label class="btn secondary"
                 style="display:inline-flex; align-items:center; gap:10px; cursor:pointer;">
            Importar BD (JSON)
            <input id="fileImport"
                   type="file"
                   accept="application/json"
                   style="display:none;" />
          </label>
        </div>

        <div class="muted" id="backupMsg" style="margin-top:10px;"></div>
      </div>

    </section>
    <section id="viewCategorias" class="hidden">
    <div class="card">
        <div class="row" style="justify-content:space-between;">
        <div>
            <h2 style="margin:0; font-size:18px;">Gastos por categoria</h2>
            <div class="muted">Veja os lançamentos filtrados por categoria no mês selecionado.</div>
        </div>
        <div>
            <label>Mês</label>
            <input type="month" id="catMonthPicker" />
        </div>
        </div>
    </div>

    <div class="card">
        <div class="row" style="justify-content:space-between;">
        <div class="pill"><span class="muted">Total no mês:</span> <strong id="catTotalMes">R$ 0,00</strong></div>
        <div class="pill"><span class="muted">Categoria:</span> <strong id="catAtual">—</strong></div>
        </div>
    </div>

    <div class="card">
        <label>Selecione a categoria</label>
        <select id="catSelect"></select>
        <div class="muted" id="catEmpty" style="margin-top:8px;"></div>
    </div>

    <div class="card">
        <h3 style="margin:0 0 12px 0; font-size:16px;">Lançamentos da categoria</h3>
        <div class="list" id="catList"></div>
        <div class="muted" id="catListEmpty" style="margin-top:8px;"></div>
    </div>
    </section>

    <!-- Modal editar -->
    <dialog id="dlgEdit">
      <form method="dialog" class="card" style="box-shadow:none; margin:0;">
        <h2 style="margin:0 0 16px 0; font-size:18px;">Editar gasto</h2>

        <input type="hidden" id="eId" />
        <div class="grid">
          <div>
            <label>Data</label>
            <input type="date" id="eData" />
          </div>
          <div>
            <label>Categoria</label>
            <select id="eCategoria">
                <option value="Mercado">Mercado</option>
                <option value="Restaurante/Bar/iFood">Restaurante/Bar/iFood</option>
                <option value="Farmácia">Farmácia</option>
                <option value="Roupas">Roupas</option>
                <option value="Beleza">Beleza</option>
                <option value="Passagem">Passagem</option>
                <option value="Outros">Outros</option>
            </select>
          </div>
          <div>
            <label>Loja</label>
            <select id="eLoja"></select>
            <button class="btn secondary" type="button" id="btnAddStoreE" style="margin-top:10px; width:100%;">Cadastrar loja</button>
          </div>
            <div>
            <label>Quantidade</label>
            <input type="text" inputmode="decimal" id="eQtd" />
            </div>

            <div>
            <label>Unidade</label>
            <select id="eUnit">
                <option value="un">Unidade (un)</option>
                <option value="kg">Quilo (kg)</option>
                <option value="g">Gramas (g)</option>
                <option value="l">Litro (L)</option>
                <option value="ml">Mililitro (mL)</option>
            </select>
            </div>

            <div>
            <label>Preço por unidade</label>
            <input type="text" id="eUnitPrice" disabled />
        </div>

          <div>
            <label>Valor (R$)</label>
            <input type="text" inputmode="decimal" id="eValor" />
          </div>

          <div>
            <label>Item</label>
            <input type="text" id="eItem" />
          </div>


          <div>
            <label>Obs</label>
            <input type="text" id="eObs" />
          </div>
        </div>

        <div class="dialog-actions">
          <button class="btn secondary" value="cancel">Cancelar</button>
          <button class="btn danger" id="btnDelete" type="button">Excluir</button>
          <button class="btn" id="btnSave" type="button">Salvar</button>
        </div>
        <div class="muted" id="msgEdit" style="margin-top:10px;"></div>
      </form>
    </dialog>
  </main>

  <script src="db.js"></script>
  <script src="app.js"></script>

  <script>
    // registra service worker (PWA/offline)
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => navigator.serviceWorker.register("./service-worker.js"));
    }
  </script>
</body>
</html>
